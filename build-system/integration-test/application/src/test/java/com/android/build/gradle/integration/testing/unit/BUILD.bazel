load("//tools/base/bazel:maven.bzl", "maven_repo")
load("//tools/base/bazel:kotlin.bzl", "kotlin_library", "kotlin_test", "kotlin_jar")
load("//tools/base/build-system/integration-test:integration-test.bzl", "gradle_integration_test")

TEST_DEPS = [
    "//tools/analytics-library/protos/src/main/proto",
    "//tools/base/build-system/integration-test/framework",
    "//tools/base/build-system/integration-test/framework/src/main/proto",
    "//tools/apksig",
    "//tools/apkzlib",
    "//tools/base/annotations",
    "//tools/base/build-system:gradle-api",
    "//tools/base/build-system/builder-test-api:tools.builder-test-api",
    "//tools/base/build-system/builder",
    "//tools/base/build-system/builder-model",
    "//tools/base/build-system/gradle-api",
    "//tools/base/build-system/gradle-core",
    "//tools/base/common:tools.common",
    "//tools/base/ddmlib:tools.ddmlib",
    "//tools/base/repository:tools.repository",
    "//tools/base/sdk-common:tools.sdk-common",
    "//tools/base/sdklib:tools.sdklib",
    "//tools/base/testutils:tools.testutils",
    "//tools/base/third_party:com.google.guava_guava",
    "//tools/base/third_party:com.google.protobuf_protobuf-java",
    "//tools/base/third_party:com.google.protobuf_protobuf-java-util",
    "//tools/base/third_party:com.google.truth_truth",
    "//tools/base/third_party:commons-io_commons-io",  # TODO: remove?
    "//tools/base/third_party:org.apache.commons_commons-compress",
    "//tools/base/third_party:org.codehaus.groovy_groovy-all",
    "//tools/base/third_party:org.mockito_mockito-core",
    "//tools/base/third_party:org.ow2.asm_asm",
    "//tools/base/third_party:org.ow2.asm_asm-tree",
    "//tools/base/third_party:org.smali_dexlib2",
    "//tools/base/third_party:org.jetbrains.kotlin_kotlin-stdlib",
    "//tools/base/third_party:org.jetbrains.kotlin_kotlin-test",
]

TEST_DATA = [
    "//tools/base/build-system/integration-test:test-projects",
    "//prebuilts/studio/sdk:add-ons/addon-google_apis-google-latest",
    "//prebuilts/studio/sdk:build-tools/latest",
    "//prebuilts/studio/sdk:cmake",
    "//prebuilts/studio/sdk:ndk-bundle",
    "//prebuilts/studio/sdk:platform-tools",
    "//prebuilts/studio/sdk:platforms/latest",
    "//prebuilts/tools/common/cmake:cmake-3.8.2",
    "//prebuilts/tools/common/kotlin-plugin:Kotlin/kotlinc/build.txt",
    "//tools/base/build-system:gradle-distrib",
    "//tools/base/build-system/aapt2:aapt2_for_tests",
]

gradle_integration_test(
    name = "tests",
    timeout = "eternal",
    srcs = glob(
        [
            "**/*.java",
        ],
    ),
    data = TEST_DATA,
    maven_repos = [
        "//tools/base/build-system:gradle_plugin_no_databinding_repo",
        "//tools/base/build-system/integration-test/application/src/test/java/com/android/build/gradle/integration/testing/unit:prebuilts",
        "//tools/base/build-system/integration-test:support_library_latest",
        "//tools/base/build-system/integration-test:androidx_latest",
    ],
    resources = glob(["src/test/resources/**"]),
    shard_count = 4,
    tags = [
        "no_test_windows",  # b/128839160
    ],
    deps = TEST_DEPS,
)

# Maven repo with all the dependencies required by test projects.
#
# Quick way of updating this list:
# - Run the new test with bazel
# - Copy the output log to $PWD/test.log
# - Run this command:
# grep -F '> Could not find' test.log \
#   | sed -e 's/:/\//g' \
#   | sed -e 's/\.$/:jar",/' \
#   | sed -e 's/\([a-z]\)\.\([a-z]\)/\1\/\2/g'
maven_repo(
    name = "prebuilts",
    # keep sorted
    artifacts = [
        "//prebuilts/tools/common/m2/repository/android/arch/core/common/1.1.1:jar",
        "//prebuilts/tools/common/m2/repository/android/arch/core/runtime/1.1.1:aar",
        "//prebuilts/tools/common/m2/repository/android/arch/lifecycle/common/1.1.1:jar",
        "//prebuilts/tools/common/m2/repository/android/arch/lifecycle/livedata-core/1.1.1:aar",
        "//prebuilts/tools/common/m2/repository/android/arch/lifecycle/livedata/1.1.1:aar",
        "//prebuilts/tools/common/m2/repository/android/arch/lifecycle/runtime/1.1.1:aar",
        "//prebuilts/tools/common/m2/repository/android/arch/lifecycle/viewmodel/1.1.1:aar",
        "//prebuilts/tools/common/m2/repository/backport-util-concurrent/backport-util-concurrent/3.1:jar",
        "//prebuilts/tools/common/m2/repository/classworlds/classworlds/1.1-alpha-2:jar",
        "//prebuilts/tools/common/m2/repository/com/almworks/sqlite4java/sqlite4java/0.282:jar",
        "//prebuilts/tools/common/m2/repository/com/android/support/animated-vector-drawable/28.0.0:aar",
        "//prebuilts/tools/common/m2/repository/com/android/support/appcompat-v7/28.0.0:aar",
        "//prebuilts/tools/common/m2/repository/com/android/support/asynclayoutinflater/28.0.0:aar",
        "//prebuilts/tools/common/m2/repository/com/android/support/collections/28.0.0:jar",
        "//prebuilts/tools/common/m2/repository/com/android/support/constraint/constraint-layout-solver/1.0.2:jar",
        "//prebuilts/tools/common/m2/repository/com/android/support/constraint/constraint-layout/1.0.2:aar",
        "//prebuilts/tools/common/m2/repository/com/android/support/coordinatorlayout/28.0.0:aar",
        "//prebuilts/tools/common/m2/repository/com/android/support/cursoradapter/28.0.0:aar",
        "//prebuilts/tools/common/m2/repository/com/android/support/customview/28.0.0:aar",
        "//prebuilts/tools/common/m2/repository/com/android/support/documentfile/28.0.0:aar",
        "//prebuilts/tools/common/m2/repository/com/android/support/drawerlayout/28.0.0:aar",
        "//prebuilts/tools/common/m2/repository/com/android/support/interpolator/28.0.0:aar",
        "//prebuilts/tools/common/m2/repository/com/android/support/loader/28.0.0:aar",
        "//prebuilts/tools/common/m2/repository/com/android/support/localbroadcastmanager/28.0.0:aar",
        "//prebuilts/tools/common/m2/repository/com/android/support/print/28.0.0:aar",
        "//prebuilts/tools/common/m2/repository/com/android/support/slidingpanelayout/28.0.0:aar",
        "//prebuilts/tools/common/m2/repository/com/android/support/support-annotations/28.0.0:jar",
        "//prebuilts/tools/common/m2/repository/com/android/support/support-compat/28.0.0:aar",
        "//prebuilts/tools/common/m2/repository/com/android/support/support-core-ui/28.0.0:aar",
        "//prebuilts/tools/common/m2/repository/com/android/support/support-core-utils/28.0.0:aar",
        "//prebuilts/tools/common/m2/repository/com/android/support/support-fragment/28.0.0:aar",
        "//prebuilts/tools/common/m2/repository/com/android/support/support-vector-drawable/28.0.0:aar",
        "//prebuilts/tools/common/m2/repository/com/android/support/swiperefreshlayout/28.0.0:aar",
        "//prebuilts/tools/common/m2/repository/com/android/support/versionedparcelable/28.0.0:aar",
        "//prebuilts/tools/common/m2/repository/com/android/support/viewpager/28.0.0:aar",
        "//prebuilts/tools/common/m2/repository/com/google/android/apps/common/testing/accessibility/framework/accessibility-test-framework/2.1:jar",
        "//prebuilts/tools/common/m2/repository/com/google/guava/guava/19.0:jar",
        "//prebuilts/tools/common/m2/repository/com/google/guava/guava/20.0:jar",
        "//prebuilts/tools/common/m2/repository/com/google/protobuf/protobuf-java/2.6.1:jar",
        "//prebuilts/tools/common/m2/repository/com/ibm/icu/icu4j/53.1:jar",
        "//prebuilts/tools/common/m2/repository/com/thoughtworks/xstream/xstream/1.4.8:jar",
        "//prebuilts/tools/common/m2/repository/commons-logging/commons-logging/1.1.1:jar",
        "//prebuilts/tools/common/m2/repository/de/undercouch/gradle-download-task/3.4.3:jar",
        "//prebuilts/tools/common/m2/repository/nekohtml/nekohtml/1.9.6.2:jar",
        "//prebuilts/tools/common/m2/repository/nekohtml/xercesMinimal/1.9.6.2:jar",
        "//prebuilts/tools/common/m2/repository/net/bytebuddy/byte-buddy-agent/1.6.5:jar",
        "//prebuilts/tools/common/m2/repository/net/bytebuddy/byte-buddy/1.6.5:jar",
        "//prebuilts/tools/common/m2/repository/org/apache/ant/ant-launcher/1.8.0:jar",
        "//prebuilts/tools/common/m2/repository/org/apache/ant/ant/1.8.0:jar",
        "//prebuilts/tools/common/m2/repository/org/apache/maven/maven-ant-tasks/2.1.3:jar",
        "//prebuilts/tools/common/m2/repository/org/apache/maven/maven-artifact-manager/2.2.1:jar",
        "//prebuilts/tools/common/m2/repository/org/apache/maven/maven-artifact/2.2.1:jar",
        "//prebuilts/tools/common/m2/repository/org/apache/maven/maven-error-diagnostics/2.2.1:jar",
        "//prebuilts/tools/common/m2/repository/org/apache/maven/maven-model/2.2.1:jar",
        "//prebuilts/tools/common/m2/repository/org/apache/maven/maven-plugin-registry/2.2.1:jar",
        "//prebuilts/tools/common/m2/repository/org/apache/maven/maven-profile/2.2.1:jar",
        "//prebuilts/tools/common/m2/repository/org/apache/maven/maven-project/2.2.1:jar",
        "//prebuilts/tools/common/m2/repository/org/apache/maven/maven-repository-metadata/2.2.1:jar",
        "//prebuilts/tools/common/m2/repository/org/apache/maven/maven-settings/2.2.1:jar",
        "//prebuilts/tools/common/m2/repository/org/apache/maven/wagon/wagon-file/1.0-beta-6:jar",
        "//prebuilts/tools/common/m2/repository/org/apache/maven/wagon/wagon-http-lightweight/1.0-beta-6:jar",
        "//prebuilts/tools/common/m2/repository/org/apache/maven/wagon/wagon-http-shared/1.0-beta-6:jar",
        "//prebuilts/tools/common/m2/repository/org/apache/maven/wagon/wagon-provider-api/1.0-beta-6:jar",
        "//prebuilts/tools/common/m2/repository/org/bouncycastle/bcprov-jdk15on/1.52:jar",
        "//prebuilts/tools/common/m2/repository/org/codehaus/plexus/plexus-container-default/1.0-alpha-9-stable-1:jar",
        "//prebuilts/tools/common/m2/repository/org/codehaus/plexus/plexus-interpolation/1.11:jar",
        "//prebuilts/tools/common/m2/repository/org/codehaus/plexus/plexus-utils/1.5.15:jar",
        "//prebuilts/tools/common/m2/repository/org/hamcrest/hamcrest-integration/1.3:jar",
        "//prebuilts/tools/common/m2/repository/org/hamcrest/hamcrest-library/1.3:jar",
        "//prebuilts/tools/common/m2/repository/org/jdeferred/jdeferred-android-aar/1.2.3:aar",
        "//prebuilts/tools/common/m2/repository/org/jdeferred/jdeferred-core/1.2.3:jar",
        "//prebuilts/tools/common/m2/repository/org/jetbrains/intellij/deps/trove4j/1.0.20181211:jar",
        "//prebuilts/tools/common/m2/repository/org/jetbrains/kotlin/kotlin-android-extensions/1.3.61:jar",
        "//prebuilts/tools/common/m2/repository/org/jetbrains/kotlin/kotlin-annotation-processing-gradle/1.3.61:jar",
        "//prebuilts/tools/common/m2/repository/org/jetbrains/kotlin/kotlin-build-common/1.3.61:jar",
        "//prebuilts/tools/common/m2/repository/org/jetbrains/kotlin/kotlin-compiler-embeddable/1.3.61:jar",
        "//prebuilts/tools/common/m2/repository/org/jetbrains/kotlin/kotlin-compiler-runner/1.3.61:jar",
        "//prebuilts/tools/common/m2/repository/org/jetbrains/kotlin/kotlin-daemon-client/1.3.61:jar",
        "//prebuilts/tools/common/m2/repository/org/jetbrains/kotlin/kotlin-daemon-embeddable/1.3.61:jar",
        "//prebuilts/tools/common/m2/repository/org/jetbrains/kotlin/kotlin-gradle-plugin-api/1.3.61:jar",
        "//prebuilts/tools/common/m2/repository/org/jetbrains/kotlin/kotlin-gradle-plugin-model/1.3.61:jar",
        "//prebuilts/tools/common/m2/repository/org/jetbrains/kotlin/kotlin-gradle-plugin/1.3.61:jar",
        "//prebuilts/tools/common/m2/repository/org/jetbrains/kotlin/kotlin-native-utils/1.3.61:jar",
        "//prebuilts/tools/common/m2/repository/org/jetbrains/kotlin/kotlin-script-runtime/1.3.61:jar",
        "//prebuilts/tools/common/m2/repository/org/jetbrains/kotlin/kotlin-scripting-common/1.3.61:jar",
        "//prebuilts/tools/common/m2/repository/org/jetbrains/kotlin/kotlin-scripting-compiler-embeddable/1.3.61:jar",
        "//prebuilts/tools/common/m2/repository/org/jetbrains/kotlin/kotlin-scripting-compiler-impl-embeddable/1.3.61:jar",
        "//prebuilts/tools/common/m2/repository/org/jetbrains/kotlin/kotlin-scripting-jvm/1.3.61:jar",
        "//prebuilts/tools/common/m2/repository/org/jetbrains/kotlin/kotlin-util-io/1.3.61:jar",
        "//prebuilts/tools/common/m2/repository/org/jetbrains/kotlinx/kotlinx-coroutines-core/1.2.1:jar",
        "//prebuilts/tools/common/m2/repository/org/mockito/mockito-core/2.7.1:jar",
        "//prebuilts/tools/common/m2/repository/org/objenesis/objenesis/2.5:jar",
        "//prebuilts/tools/common/m2/repository/org/ow2/asm/asm-commons/5.0.1:jar",
        "//prebuilts/tools/common/m2/repository/org/ow2/asm/asm-tree/5.0.1:jar",
        "//prebuilts/tools/common/m2/repository/org/ow2/asm/asm/5.0.1:jar",
        "//prebuilts/tools/common/m2/repository/org/robolectric/android-all/7.0.0_r1-robolectric-r1:jar",
        "//prebuilts/tools/common/m2/repository/org/robolectric/annotations/4.2.1:jar",
        "//prebuilts/tools/common/m2/repository/org/robolectric/junit/4.2.1:jar",
        "//prebuilts/tools/common/m2/repository/org/robolectric/pluginapi/4.2.1:jar",
        "//prebuilts/tools/common/m2/repository/org/robolectric/plugins-maven-dependency-resolver/4.2.1:jar",
        "//prebuilts/tools/common/m2/repository/org/robolectric/resources/4.2.1:jar",
        "//prebuilts/tools/common/m2/repository/org/robolectric/robolectric/4.2.1:jar",
        "//prebuilts/tools/common/m2/repository/org/robolectric/sandbox/4.2.1:jar",
        "//prebuilts/tools/common/m2/repository/org/robolectric/shadowapi/4.2.1:jar",
        "//prebuilts/tools/common/m2/repository/org/robolectric/shadows-framework/4.2.1:jar",
        "//prebuilts/tools/common/m2/repository/org/robolectric/utils-reflector/4.2.1:jar",
        "//prebuilts/tools/common/m2/repository/org/robolectric/utils/4.2.1:jar",
        "//prebuilts/tools/common/m2/repository/org/slf4j/slf4j-api/1.7.2:jar",
        "//prebuilts/tools/common/m2/repository/xmlpull/xmlpull/1.1.3.1:jar",
        "//prebuilts/tools/common/m2/repository/xpp3/xpp3_min/1.1.4c:jar",
        "//tools/base/testing-infrastructure/device-pool/device-provider",  # TODO: neverlink
        "//tools/base/third_party:junit_junit",
    ],
    visibility = ["__subpackages__"],
)
