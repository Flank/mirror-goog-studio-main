load("//tools/base/bazel:maven.bzl", "maven_repo")
load("//tools/base/build-system/integration-test:integration-test.bzl", "gradle_integration_test")

TEST_DEPS = [
    "//tools/analytics-library/protos/src/main/proto",
    "//tools/base/build-system/integration-test/framework",
    "//tools/base/build-system/integration-test/framework/src/main/proto",
    "//tools/apksig",
    "//tools/apkzlib",
    "//tools/base/annotations",
    "//tools/base/build-system:gradle-api",
    "//tools/base/build-system/builder-test-api:tools.builder-test-api",
    "//tools/base/build-system/builder",
    "//tools/base/build-system/builder-model",
    "//tools/base/build-system/gradle-api",
    "//tools/base/build-system/gradle-core",
    "//tools/base/common:tools.common",
    "//tools/base/ddmlib:tools.ddmlib",
    "//tools/base/repository:tools.repository",
    "//tools/base/sdk-common:tools.sdk-common",
    "//tools/base/sdklib:tools.sdklib",
    "//tools/base/testutils:tools.testutils",
    "@maven//:com.google.guava.guava",
    "@maven//:com.google.protobuf.protobuf-java",
    "@maven//:com.google.protobuf.protobuf-java-util",
    "@maven//:com.google.truth.truth",
    "@maven//:commons-io.commons-io",  # TODO: remove?
    "@maven//:org.apache.commons.commons-compress",
    "@maven//:org.codehaus.groovy.groovy-all",  # required by //tools/base/build-system:gradle-api
    "@maven//:org.mockito.mockito-core",
    "@maven//:org.ow2.asm.asm",
    "@maven//:org.ow2.asm.asm-tree",
    "@maven//:org.smali.dexlib2",
    "@maven//:org.jetbrains.kotlin.kotlin-stdlib",
    "@maven//:org.jetbrains.kotlin.kotlin-test",
]

TEST_DATA = [
    "//tools/base/build-system/integration-test:test-projects/unitTesting",
    "//tools/base/build-system/integration-test:test-projects/unitTestingAndroidResources",
    "//tools/base/build-system/integration-test:test-projects/unitTestingBuildTypes",
    "//tools/base/build-system/integration-test:test-projects/unitTestingComplexProject",
    "//tools/base/build-system/integration-test:test-projects/unitTestingDefaultValues",
    "//tools/base/build-system/integration-test:test-projects/unitTestingFlavors",
    "//prebuilts/studio/sdk:add-ons/addon-google_apis-google-latest",
    "//prebuilts/studio/sdk:build-tools/latest",
    "//prebuilts/studio/sdk:cmake",
    "//prebuilts/studio/sdk:ndk-bundle",
    "//prebuilts/studio/sdk:platform-tools",
    "//prebuilts/studio/sdk:platforms/latest",
    "//prebuilts/tools/common/cmake:cmake-3.8.2",
    "//tools/base/build-system:gradle-distrib",
    "//tools/base/build-system/aapt2:aapt2_for_tests",
]

gradle_integration_test(
    name = "tests",
    srcs = glob(
        [
            "**/*.java",
        ],
    ),
    data = TEST_DATA,
    maven_repos = [
        "//tools/base/build-system:gradle_plugin_no_databinding_repo",
        "//tools/base/build-system/integration-test/application/src/test/java/com/android/build/gradle/integration/testing/unit:prebuilts",
        "//tools/base/build-system/integration-test:support_library_latest",
        "//tools/base/build-system/integration-test:androidx_latest",
        "//tools/base/build-system/integration-test:kotlin_gradle_plugin_prebuilts",
    ],
    resources = glob(["src/test/resources/**"]),
    shard_count = 4,
    tags = [
        "no_test_windows",  # b/128839160
    ],
    deps = TEST_DEPS,
)

# Maven repo with all the dependencies required by test projects.
#
# Quick way of updating this list:
# - Run the new test with bazel
# - Copy the output log to $PWD/test.log
# - Run this command:
# grep -F '> Could not find' test.log \
#   | sed -e 's/:/\//g' \
#   | sed -e 's/\.$/:jar",/' \
#   | sed -e 's/\([a-z]\)\.\([a-z]\)/\1\/\2/g'
maven_repo(
    name = "prebuilts",
    # keep sorted
    artifacts = [
        "//prebuilts/tools/common/m2:android.arch.core.common.1.1.1",
        "//prebuilts/tools/common/m2:android.arch.core.runtime.1.1.1_aar",
        "//prebuilts/tools/common/m2:android.arch.lifecycle.common.1.1.1",
        "//prebuilts/tools/common/m2:android.arch.lifecycle.livedata.1.1.1_aar",
        "//prebuilts/tools/common/m2:android.arch.lifecycle.livedata-core.1.1.1_aar",
        "//prebuilts/tools/common/m2:android.arch.lifecycle.runtime.1.1.1_aar",
        "//prebuilts/tools/common/m2:android.arch.lifecycle.viewmodel.1.1.1_aar",
        "//prebuilts/tools/common/m2:backport-util-concurrent.backport-util-concurrent.3.1",
        "//prebuilts/tools/common/m2:classworlds.classworlds.1.1-alpha-2",
        "//prebuilts/tools/common/m2:com.almworks.sqlite4java.sqlite4java.0.282",
        "//prebuilts/tools/common/m2:com.android.support.animated-vector-drawable.28.0.0_aar",
        "//prebuilts/tools/common/m2:com.android.support.appcompat-v7.28.0.0_aar",
        "//prebuilts/tools/common/m2:com.android.support.asynclayoutinflater.28.0.0_aar",
        "//prebuilts/tools/common/m2:com.android.support.collections.28.0.0",
        "//prebuilts/tools/common/m2:com.android.support.constraint.constraint-layout.1.0.2_aar",
        "//prebuilts/tools/common/m2:com.android.support.constraint.constraint-layout-solver.1.0.2",
        "//prebuilts/tools/common/m2:com.android.support.coordinatorlayout.28.0.0_aar",
        "//prebuilts/tools/common/m2:com.android.support.cursoradapter.28.0.0_aar",
        "//prebuilts/tools/common/m2:com.android.support.customview.28.0.0_aar",
        "//prebuilts/tools/common/m2:com.android.support.documentfile.28.0.0_aar",
        "//prebuilts/tools/common/m2:com.android.support.drawerlayout.28.0.0_aar",
        "//prebuilts/tools/common/m2:com.android.support.interpolator.28.0.0_aar",
        "//prebuilts/tools/common/m2:com.android.support.loader.28.0.0_aar",
        "//prebuilts/tools/common/m2:com.android.support.localbroadcastmanager.28.0.0_aar",
        "//prebuilts/tools/common/m2:com.android.support.print.28.0.0_aar",
        "//prebuilts/tools/common/m2:com.android.support.slidingpanelayout.28.0.0_aar",
        "//prebuilts/tools/common/m2:com.android.support.support-annotations.28.0.0",
        "//prebuilts/tools/common/m2:com.android.support.support-compat.28.0.0_aar",
        "//prebuilts/tools/common/m2:com.android.support.support-core-ui.28.0.0_aar",
        "//prebuilts/tools/common/m2:com.android.support.support-core-utils.28.0.0_aar",
        "//prebuilts/tools/common/m2:com.android.support.support-fragment.28.0.0_aar",
        "//prebuilts/tools/common/m2:com.android.support.support-vector-drawable.28.0.0_aar",
        "//prebuilts/tools/common/m2:com.android.support.swiperefreshlayout.28.0.0_aar",
        "//prebuilts/tools/common/m2:com.android.support.versionedparcelable.28.0.0_aar",
        "//prebuilts/tools/common/m2:com.android.support.viewpager.28.0.0_aar",
        "//prebuilts/tools/common/m2:com.github.gundy.semver4j.0.16.4",
        "//prebuilts/tools/common/m2:com.google.android.apps.common.testing.accessibility.framework.accessibility-test-framework.2.1",
        "//prebuilts/tools/common/m2:com.google.guava.guava.19.0",
        "//prebuilts/tools/common/m2:com.google.guava.guava.20.0",
        "//prebuilts/tools/common/m2:com.google.j2objc.j2objc-annotations.1.1",
        "//prebuilts/tools/common/m2:com.google.protobuf.protobuf-java.2.6.1",
        "//prebuilts/tools/common/m2:com.ibm.icu.icu4j.53.1",
        "//prebuilts/tools/common/m2:com.thoughtworks.xstream.xstream.1.4.8",
        "//prebuilts/tools/common/m2:commons-logging.commons-logging.1.1.1",
        "//prebuilts/tools/common/m2:de.undercouch.gradle-download-task.4.0.2",
        "//prebuilts/tools/common/m2:nekohtml.nekohtml.1.9.6.2",
        "//prebuilts/tools/common/m2:nekohtml.xercesMinimal.1.9.6.2",
        "//prebuilts/tools/common/m2:net.bytebuddy.byte-buddy.1.6.5",
        "//prebuilts/tools/common/m2:net.bytebuddy.byte-buddy.1.9.10",
        "//prebuilts/tools/common/m2:net.bytebuddy.byte-buddy-agent.1.6.5",
        "//prebuilts/tools/common/m2:net.bytebuddy.byte-buddy-agent.1.9.10",
        "//prebuilts/tools/common/m2:org.antlr.antlr4-runtime.4.5.2-1",
        "//prebuilts/tools/common/m2:org.apache.ant.ant.1.8.0",
        "//prebuilts/tools/common/m2:org.apache.ant.ant-launcher.1.8.0",
        "//prebuilts/tools/common/m2:org.apache.maven.maven-ant-tasks.2.1.3",
        "//prebuilts/tools/common/m2:org.apache.maven.maven-artifact.2.2.1",
        "//prebuilts/tools/common/m2:org.apache.maven.maven-artifact-manager.2.2.1",
        "//prebuilts/tools/common/m2:org.apache.maven.maven-error-diagnostics.2.2.1",
        "//prebuilts/tools/common/m2:org.apache.maven.maven-model.2.2.1",
        "//prebuilts/tools/common/m2:org.apache.maven.maven-plugin-registry.2.2.1",
        "//prebuilts/tools/common/m2:org.apache.maven.maven-profile.2.2.1",
        "//prebuilts/tools/common/m2:org.apache.maven.maven-project.2.2.1",
        "//prebuilts/tools/common/m2:org.apache.maven.maven-repository-metadata.2.2.1",
        "//prebuilts/tools/common/m2:org.apache.maven.maven-settings.2.2.1",
        "//prebuilts/tools/common/m2:org.apache.maven.wagon.wagon-file.1.0-beta-6",
        "//prebuilts/tools/common/m2:org.apache.maven.wagon.wagon-http-lightweight.1.0-beta-6",
        "//prebuilts/tools/common/m2:org.apache.maven.wagon.wagon-http-shared.1.0-beta-6",
        "//prebuilts/tools/common/m2:org.apache.maven.wagon.wagon-provider-api.1.0-beta-6",
        "//prebuilts/tools/common/m2:org.bouncycastle.bcprov-jdk15on.1.52",
        "//prebuilts/tools/common/m2:org.codehaus.plexus.plexus-container-default.1.0-alpha-9-stable-1",
        "//prebuilts/tools/common/m2:org.codehaus.plexus.plexus-interpolation.1.11",
        "//prebuilts/tools/common/m2:org.codehaus.plexus.plexus-utils.1.5.15",
        "//prebuilts/tools/common/m2:org.hamcrest.hamcrest-integration.1.3",
        "//prebuilts/tools/common/m2:org.hamcrest.hamcrest-library.1.3",
        "//prebuilts/tools/common/m2:org.jdeferred.jdeferred-android-aar.1.2.3_aar",
        "//prebuilts/tools/common/m2:org.jdeferred.jdeferred-core.1.2.3",
        "//prebuilts/tools/common/m2:org.jetbrains.kotlinx.kotlinx-coroutines-core.1.3.8",
        "//prebuilts/tools/common/m2:org.mockito.mockito-core.3.0.0",
        "//prebuilts/tools/common/m2:org.objenesis.objenesis.2.6",
        "//prebuilts/tools/common/m2:org.ow2.asm.asm.5.0.1",
        "//prebuilts/tools/common/m2:org.ow2.asm.asm-commons.5.0.1",
        "//prebuilts/tools/common/m2:org.ow2.asm.asm-tree.5.0.1",
        "//prebuilts/tools/common/m2:org.robolectric.android-all.7.0.0_r1-robolectric-r1",
        "//prebuilts/tools/common/m2:org.robolectric.annotations.4.2.1",
        "//prebuilts/tools/common/m2:org.robolectric.junit.4.2.1",
        "//prebuilts/tools/common/m2:org.robolectric.pluginapi.4.2.1",
        "//prebuilts/tools/common/m2:org.robolectric.plugins-maven-dependency-resolver.4.2.1",
        "//prebuilts/tools/common/m2:org.robolectric.resources.4.2.1",
        "//prebuilts/tools/common/m2:org.robolectric.robolectric.4.2.1",
        "//prebuilts/tools/common/m2:org.robolectric.sandbox.4.2.1",
        "//prebuilts/tools/common/m2:org.robolectric.shadowapi.4.2.1",
        "//prebuilts/tools/common/m2:org.robolectric.shadows-framework.4.2.1",
        "//prebuilts/tools/common/m2:org.robolectric.utils.4.2.1",
        "//prebuilts/tools/common/m2:org.robolectric.utils-reflector.4.2.1",
        "//prebuilts/tools/common/m2:org.slf4j.slf4j-api.1.7.2",
        "//prebuilts/tools/common/m2:xmlpull.xmlpull.1.1.3.1",
        "//prebuilts/tools/common/m2:xpp3.xpp3_min.1.1.4c",
        "//tools/base/testing-infrastructure/device-pool/device-provider",  # TODO: neverlink
        "//tools/base/third_party:junit_junit",
    ],
    visibility = ["__subpackages__"],
)
