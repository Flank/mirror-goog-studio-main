/*
 * Copyright (C) 2016 The Android Open Source Project
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
syntax = "proto3";

package profiler.proto;
option java_package = "com.android.tools.profiler.proto";
option java_outer_classname = "Commands";

import "app_inspection.proto";
import "common.proto";
import "cpu_data.proto";
import "echo.proto";
import "layout_inspector.proto";
import "memory_data.proto";

message Command {
  enum CommandType {
    UNSPECIFIED = 0;

    // Comonn transport commands starts at 10.
    ATTACH_AGENT = 10;

    // General profiler commands starts at 100.
    BEGIN_SESSION = 100;
    END_SESSION = 101;

    // Network Profiler Prefix = 200

    // Cpu Profiler Prefix = 300
    START_CPU_TRACE = 301;
    STOP_CPU_TRACE = 302;
    GET_CPU_CORE_CONFIG = 303;

    // Memory Profiler Prefix = 400
    GC = 401; // No payload
    HEAP_DUMP = 402;  // No payload
    MEMORY_ALLOC_SAMPLING = 403;
    START_ALLOC_TRACKING = 404;
    STOP_ALLOC_TRACKING = 405;

    // Energy Profiler Prefix = 500
    // Event Profiler Prefix = 600

    // Sample echo Command
    ECHO = 1000;

    // Layout inspector command.
    LAYOUT_INSPECTOR = 1100;

    // App inspection command
    APP_INSPECTION = 1200;
  }

  // A stream is an entity that provides data, such as a device or an imported
  // file.
  int64 stream_id = 1;  // If ommited the command is applied to all streams
  CommandType type = 2;
  // The process if the command needs one, or if the command should be forwarded
  // to an agent attached to the process. Empty otherwise.
  int32 pid = 3;
  // Command id that events triggered by the command can associate with.
  // This is auto-generated by the pipeline when Execute is called and is
  // unique per stream.
  int32 command_id = 4;
  oneof union {
    // General transport commands starts at 10.
    AttachAgent attach_agent = 10;

    // General profiler commands starts at 100.
    BeginSession begin_session = 100;
    EndSession end_session = 101;

    // Network Profiler Prefix = 200

    // Cpu Profiler Prefix = 300
    StartCpuTrace start_cpu_trace = 301;
    StopCpuTrace stop_cpu_trace = 302;
    GetCpuCoreConfig get_cpu_core_config = 303;

    // Memory Profiler Prefix = 400
    // 401 Reserved for CommandType.GC
    // 402 Reserved for CommandType.HEAP_DUMP
    MemoryAllocSamplingData memory_alloc_sampling = 403;
    StartAllocTracking start_alloc_tracking = 404;
    StopAllocTracking stop_alloc_tracking = 405;

    // Energy Profiler Prefix = 500
    // Event Profiler Prefix = 600

    // Sample Echo Command starts at 1000;
    echo.EchoData echo_data = 1000;

    // Layout editor starts at 1100;
    layoutinspector.LayoutInspectorCommand layout_inspector = 1100;

    // App inspection prefix = 1200;
    app.inspection.AppInspectionCommand androidx_inspection_command = 1200;
  }
}

message BeginSession {
  message JvmtiConfig {
    // True if an jvmti agent should be attached, false otherwise.
    bool attach_agent = 1;
    // TODO(b/65458869): Remove when moving process discovery to perfd.
    string agent_lib_file_name = 2;
    // Path to the agent config file
    string agent_config_path = 3;
    // True if live allocation is used, false otherwise.
    bool live_allocation_enabled = 4;
  }

  JvmtiConfig jvmti_config = 1;
  int64 request_time_epoch_ms = 2;
  string session_name = 3;
  // See SdkConstans.CPU_ARCH_*
  string process_abi = 4;
}

message EndSession {
  int64 session_id = 1;
}

message AttachAgent {
  string agent_lib_file_name = 1;
  string agent_config_path = 2;
}

message GetCpuCoreConfig {
  int64 device_id = 1;
}