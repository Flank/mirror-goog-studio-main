#!/usr/bin/python
"""Runs the bazel executable for the platform, passing args along."""

import os
import re
import subprocess
import sys
import multiprocessing


def main():
  workspace = find_workspace(os.getcwd())
  if not workspace:
    sys.exit('Must run %s within a workspace.' % os.path.basename(sys.argv[0]))
  if sys.platform.startswith('linux'):
    platform = 'linux-x86_64'
    jdk_subdir = 'linux'
  elif sys.platform == 'darwin':
    platform = 'darwin-x86_64'
    jdk_subdir = os.path.join('mac', 'Contents', 'Home')
  elif sys.platform == 'win32':
    platform = 'windows-x86_64'
    jdk_subdir = 'win64'
  else:
    sys.exit('Platform %s is not yet supported.' % sys.platform)

  bazel = os.path.join(workspace, 'prebuilts', 'tools', platform, 'bazel',
                       'bazel-real')
  args = sys.argv[1:]

  env = {}
  env['JAVA_HOME'] = os.path.join(workspace, 'prebuilts', 'studio', 'jdk', jdk_subdir)
  env['TERM'] = os.environ.get('TERM', '')
  if sys.platform == 'darwin':
    args.insert(0, '--watchfs')
    env['CC'] = os.environ.get('GCC', '/usr/bin/gcc')
  elif sys.platform == 'win32':
    define_env(env, 'BAZEL_SH', 'C:\\tools\\msys64\\usr\\bin\\bash.exe',
        'NOTE: Bazel for Windows currently hardcodes "C:\\tools\\msys64", but we\n' +
        'could not find an installation of msys at this path on your machine.\n' +
        'Consider moving your installation if you already have it or\n' +
        'install it there from http://www.msys.org.\n' +
        '\n' +
        'See also: https://github.com/bazelbuild/bazel/issues/2447')
    define_env(env, 'BAZEL_VS', 'C:\\Program Files (x86)\\Microsoft Visual Studio 14.0',
        'Please install VC++ build tools for bazel to work. For a consistent version\n' +
        'use Visual C++ 2015 Build Tools which you can find at:\n' +
        'http://landinghub.visualstudio.com/visual-cpp-build-tools')
    define_env(env, 'BAZEL_PYTHON', 'C:\\python_27_amd64\\files\\python.exe')
    define_env(env, 'BAZEL_SH', 'C:\\tools\\msys64\\usr\\bin\\bash.exe')
    # Bazel for windows requires a couple of extra env vars be set
    # SYSTEMROOT must be defined to run a win .exe; otherwise, subprocess.call
    # will hang.
    env['SYSTEMROOT'] = 'C:\\Windows'
    env['TMP'] = 'C:\\Windows\\Temp'

  else: # Linux
    env['CC'] = os.environ.get('GCC', '/usr/bin/gcc')

  if bazel_command(args) == 'test':
    # Keep this logic in sync with integration-test BUILD file and CheckAllRunner.
    cpus = multiprocessing.cpu_count()
    if cpus > 20:
      # Most likely z840. For now limit test jobs to 8, until we experiment
      # with higher values.
      test_jobs = 8
    else:
      test_jobs = 2

    # Insert the flag right after "test".
    args.insert(bazel_command_index(args) + 1, '--local_test_jobs=' + str(test_jobs))
    print('Running with {} local test jobs.'.format(test_jobs))

  sys.exit(subprocess.call([bazel] + args, env=env))


def define_env(env, var, value, msg=None):
  prev = os.environ.get(var)
  if prev:
    if not os.path.exists(value):
      print '{} is set to {}, but it does not exist'.format(var, value)
      sys.exit(1)
    env[var] = prev
  elif os.path.exists(value):
    env[var] = value
  else:
    print 'Cannot find {} while trying to set "{}"'.format(value, var)
    print msg if msg else 'Make sure {} exists, or set "{}" manually to the correct value.'.format(value, var)
    sys.exit(1)


def find_workspace(path):
  if os.path.isfile(os.path.join(path, 'WORKSPACE')):
    return path
  else:
    parent = os.path.dirname(path)
    return None if parent == path else find_workspace(parent)

"""
Returns the command index, which is the first non-option argument.
https://bazel.build/versions/master/docs/command-line-reference.html
"""
def bazel_command_index(args):
  for i in range(len(args)):
    if not args[i].startswith('-'):
      return i
  return None

"""
Returns the command itself, or None if not defined.
"""
def bazel_command(args):
  index = bazel_command_index(args)
  if index is None:
    return None
  return args[index]

if __name__ == '__main__':
  main()
